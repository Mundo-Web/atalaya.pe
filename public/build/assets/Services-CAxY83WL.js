var K=Object.defineProperty;var P=(i,l,c)=>l in i?K(i,l,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[l]=c;var f=(i,l,c)=>P(i,typeof l!="symbol"?l+"":l,c);import{A as Q,i as y}from"./Adminto-DsDWm6p7.js";import{m as b,C as V,c as U,R as e,r as p}from"./CreateReactScript-BEd-rCvk.js";import{S as X}from"./sweetalert2.esm.all-B0Dix5B2.js";import{B as Y}from"./BasicRest-CK88Dw_V.js";import{U as Z}from"./UsersByServicesByBusinessesRest-CNtpCZnY.js";import{U as L}from"./UsersRest-Dt-6uLT9.js";import{S as ee}from"./SelectFormGroup-D7BQIrYb.js";import{M as te}from"./Modal-BOzbh0wA.js";class ae extends Y{constructor(){super(...arguments);f(this,"path","services-by-business");f(this,"byBusiness",async c=>{try{const{status:o,result:m}=await b.Fetch(`/api/${this.path}/${c}`);if(!o)throw new Error((m==null?void 0:m.message)||"Ocurrio un error al cargar los servicios vinculados a esta empresa");return m.data}catch(o){return console.error(o),null}});f(this,"enableService",async(c,o)=>{try{const{status:m,result:d}=await b.Fetch(`/api/${this.path}`,{method:"POST",body:JSON.stringify({business:c,service:o})});if(!m)throw new Error((d==null?void 0:d.message)||"Ocurrio un error al habilitar el servicio");return b.Notify.add({icon:"/assets/img/icon.svg",title:"Correcto",body:d.message,type:"success"}),d}catch(m){return b.Notify.add({icon:"/assets/img/icon.svg",title:"Error",body:m.message,type:"danger"}),null}})}}const ne=(i=[],l)=>{const c=[];return i.forEach((o,m)=>{m==0?c.push(o):c.push(l,o)}),c},se=new L,O=new ae,h=new Z,re=({businesses:i=[],services:l=[],session:c,APP_DOMAIN:o,APP_PROTOCOL:m})=>{var B,R,k;const d=p.useRef(),x=p.useRef(),w=p.useRef(),[g,G]=p.useState(b.GET.business),[T,j]=p.useState({}),[r,v]=p.useState(null),[J,z]=p.useState([]),[H,N]=p.useState(null);p.useEffect(()=>{E()},[g]);const E=async()=>{const t=await O.byBusiness(g),n={};for(const s of t)n[s.service.correlative]=s;return j(n),n},S=({id:t,text:n,element:s})=>{if(!t)return;const a=JSON.parse($(s).attr("data")),u=document.createElement("div");return u.style.display="block",U(u).render(e.createElement(e.Fragment,null,e.createElement("div",{className:"relative d-flex align-items-center py-2"},e.createElement("div",{className:"flex-grow-1 overflow-hidden"},e.createElement("h5",{className:"mt-0 mb-1 text-truncate"},e.createElement("i",{className:"fa fa-building me-1"}),n),e.createElement("p",{className:"d-block text-gray mb-0 font-13 text-truncate"},a.owner.name," ",a.owner.lastname))))),u},W=t=>{const n=$(d.current).find("option:selected"),a=JSON.parse(n.attr("data")).person.document_number;history.pushState(null,null,`/services?business=${a}`),G(a)},_=async(t,n)=>{const{isConfirmed:s}=await X.fire({title:"¿Estás seguro?",text:"Habilitar el servicio puede aumentar los costos.",icon:"info",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!s)return;N(n),t.target.disabled=!0;const a=await O.enableService(g,n);t.target.disabled=!1,N(null),a&&E()},q=async t=>{v(t),$(w.current).modal("show")},A=async()=>{var s,a;const t=[["email","contains",x.current.value]];(s=r==null?void 0:r.users)!=null&&s.length&&t.push("and",["!",ne((a=r==null?void 0:r.users)==null?void 0:a.map(({email:u})=>["email","=",u]),"or")]);const n=await se.paginate({filter:t});console.log(n),z((n==null?void 0:n.data)??[])},M=async t=>{const n=r.id;if(!await h.inviteUser(t,n))return;const a=await E();v(a[r.service.correlative])},D=async t=>{if(!await h.delete(t))return;const s=await E();v(s[r.service.correlative])},I=async({correlative:t})=>{const n=$(d.current).find("option:selected"),s=JSON.parse(n.attr("data"));await h.authorize({service:t,business:s.uuid})&&(location.href=`${m}://${t}.${o}/home`)};return e.createElement(e.Fragment,null,e.createElement("div",{className:"d-flex align-items-center justify-content-center",style:{minHeight:"calc(100vh - 135px)"}},e.createElement("div",null,e.createElement("div",{className:"mx-auto",style:{width:"240px"}},e.createElement(ee,{eRef:d,templateResult:S,templateSelection:S,onChange:W},i.map((t,n)=>e.createElement("option",{key:`business-${n}`,value:t.id,data:JSON.stringify(t),selected:b.GET.business==t.person.document_number},t.name)))),e.createElement("hr",{className:"mx-auto",style:{width:"180px"}}),e.createElement("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-3"},l.sort((t,n)=>n.status-t.status).map((t,n)=>{const s=T[t.correlative];return e.createElement("div",{key:`service-${n}`,className:"card mb-0",style:{width:"100%",maxWidth:"360px"}},e.createElement("div",{className:"card-body project-box"},e.createElement("div",{className:"badge bg-primary float-end"},"Gratis"),e.createElement("h4",{className:"mt-0"},e.createElement("a",{href:"#",className:"text-dark d-flex gap-1 align-items-center",onClick:()=>I(t)},e.createElement("img",{src:`//${t.correlative}.${o}/assets/img/icon.svg`,alt:t.name,style:{height:"20px",aspectRatio:1,objectFit:"contain",objectPosition:"center"},onError:a=>a.target.src="/assets/img/icon.svg"})," ",t.name," ",e.createElement("i",{className:"mdi mdi-arrow-top-right"}))),e.createElement("p",{className:"text-success text-lowercase font-13"},t.correlative,".",o),e.createElement("p",{className:"text-muted font-13",style:{display:"-webkit-box",WebkitLineClamp:2,textOverflow:"ellipsis",WebkitBoxOrient:"vertical",overflow:"hidden",height:"38px"}},t.description),e.createElement("div",{className:"project-members mb-0"},s?e.createElement(e.Fragment,null,e.createElement("h5",{className:"float-start me-3"},"Equipo :"),e.createElement("div",{className:"avatar-group"},s.users.map((a,u)=>{var C,F;return e.createElement("div",{key:`user-${u}`,className:"avatar-group-item mb-0"},e.createElement(y,{content:`${((C=a==null?void 0:a.person)==null?void 0:C.name)||(a==null?void 0:a.name)} ${((F=a==null?void 0:a.person)==null?void 0:F.lastname)||(a==null?void 0:a.lastname)} ${c.id==a.id&&"(Tú)"}`},e.createElement("img",{src:`/api/profile/thumbnail/${a.relative_id}`,className:"rounded-circle avatar-sm",alt:`${a.name} ${a.lastname}`})))}),e.createElement("div",{className:"avatar-group-item mb-0",style:{cursor:"pointer"},onClick:()=>q(s)},e.createElement(y,{content:"Gestionar usuarios"},e.createElement("img",{src:"/assets/img/plus.svg",className:"rounded-circle avatar-sm",alt:"Gestionar usuarios",style:{backgroundColor:"rgba(255, 255, 255, .5)",border:"1px solid transparent"}}))))):t.status?e.createElement(y,{content:"Habilitar servicio"},e.createElement("button",{type:"button",className:"btn btn-sm btn-soft-primary rounded-pill waves-effect waves-light",onClick:a=>_(a,t.correlative)},H?e.createElement(e.Fragment,null,e.createElement("i",{className:"mdi mdi-spin mdi-shape-circle-plus"})," Habilitando"):e.createElement(e.Fragment,null,e.createElement("i",{className:"mdi mdi-plus"})," Habilitar"))):e.createElement("span",{style:{position:"relative",marginLeft:"-24px",display:"block",backgroundColor:"#f9c851",color:"#343a40",padding:".28rem 1.56rem",width:"max-content",borderRadius:"0 25px 25px 0"}},"Proximamente"))))})))),e.createElement(te,{modalRef:w,onSubmit:t=>t.preventDefault(),title:`Gestionar acceso a ${(B=r==null?void 0:r.service)==null?void 0:B.name}`,size:"md",isStatic:!0,hideFooter:!0},e.createElement("div",{className:"d-block btn-group mx-auto",style:{width:"max-content"}},e.createElement("button",{type:"button",className:"btn btn-secondary dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":"false"},e.createElement("i",{className:"fa fa-user-plus"})," Agregar usuarios a este servicio"),e.createElement("div",{className:"dropdown-menu dropdown-menu-center p-2",style:{width:"100%"}},e.createElement("input",{ref:x,className:"form-control mb-2",type:"text",onChange:A}),J.map((t,n)=>{var s,a;return e.createElement(e.Fragment,null,e.createElement("a",{key:`user-${n}`,className:"dropdown-item py-1 px-2 border-t",href:"#",onClick:()=>M(t.email)},e.createElement("p",{className:"mb-0 text-bold text-truncate"},((s=t==null?void 0:t.person)==null?void 0:s.name)||(t==null?void 0:t.name)," ",((a=t==null?void 0:t.person)==null?void 0:a.lastname)||(t==null?void 0:t.lastname)),e.createElement("p",{className:"mb-0 text-muted text-truncate",style:{fontSize:"small"}},t.email)))}))),e.createElement("hr",{className:"mx-auto",style:{maxWidth:"240px",width:"100%"}}),e.createElement("div",null,((R=r==null?void 0:r.users)==null?void 0:R.length)>0?e.createElement("table",{style:{width:"100%"}},e.createElement("tbody",null,(k=r==null?void 0:r.users)==null?void 0:k.map((t,n)=>{var s,a;return e.createElement("tr",{key:`user-${n}`},e.createElement("td",null,e.createElement("img",{src:`/api/profile/thumbnail/${t.relative_id}`,className:"rounded-circle avatar-sm me-1",alt:`${t.name} ${t.lastname}`})),e.createElement("td",null,e.createElement("div",null,e.createElement("h5",{className:"mt-1 mb-1 text-truncate"},((s=t==null?void 0:t.person)==null?void 0:s.name)||(t==null?void 0:t.name)," ",((a=t==null?void 0:t.person)==null?void 0:a.lastname)||(t==null?void 0:t.lastname)),e.createElement("p",{className:"mb-1 text-truncate",style:{fontSize:"small"}},t==null?void 0:t.email))),e.createElement("td",{align:"center"},t.pivot.invitation_accepted==!1&&e.createElement(y,{content:"El usuario no ha aceptado la invitacion"},e.createElement("p",{className:"mb-0 text-danger",style:{fontSize:"small"}},"Pendiente")),e.createElement("button",{className:"btn btn-xs btn-white rounded-pill",onClick:()=>D(t.pivot.id)},e.createElement("i",{className:"fa fa-trash"}))))}))):e.createElement("i",{className:"d-block text-center text-muted"},"- No hay usuarios vinculados -"))))};V((i,l)=>{U(i).render(e.createElement(Q,{...l,title:"Servicios"},e.createElement(re,{...l})))});
