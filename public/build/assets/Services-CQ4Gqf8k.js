var P=Object.defineProperty;var Q=(l,r,c)=>r in l?P(l,r,{enumerable:!0,configurable:!0,writable:!0,value:c}):l[r]=c;var u=(l,r,c)=>Q(l,typeof r!="symbol"?r+"":r,c);import{m as h,C as V,c as O,j as e,r as x}from"./CreateReactScript-CjXADJBG.js";import{A as X,i as f}from"./Adminto-DVlShn4E.js";import{S as Y}from"./sweetalert2.esm.all-B0Dix5B2.js";import{B as G}from"./BasicRest-CvPeBcQU.js";import{U as Z}from"./UsersByServicesByBusinessesRest-GxCrYk1i.js";import{S as L}from"./SelectFormGroup-CAKXFvsI.js";import{M as ee}from"./Modal-CoIai94h.js";class se extends G{constructor(){super(...arguments);u(this,"path","services-by-business");u(this,"byBusiness",async c=>{try{const{status:o,result:m}=await h.Fetch(`/api/${this.path}/${c}`);if(!o)throw new Error((m==null?void 0:m.message)||"Ocurrio un error al cargar los servicios vinculados a esta empresa");return m.data}catch(o){return console.error(o),null}});u(this,"enableService",async(c,o)=>{try{const{status:m,result:d}=await h.Fetch(`/api/${this.path}`,{method:"POST",body:JSON.stringify({business:c,service:o})});if(!m)throw new Error((d==null?void 0:d.message)||"Ocurrio un error al habilitar el servicio");return h.Notify.add({icon:"/assets/img/icon.svg",title:"Correcto",body:d.message,type:"success"}),d}catch(m){return h.Notify.add({icon:"/assets/img/icon.svg",title:"Error",body:m.message,type:"danger"}),null}})}}class te extends G{constructor(){super(...arguments);u(this,"path","users")}}const ae=(l=[],r)=>{const c=[];return l.forEach((o,m)=>{m==0?c.push(o):c.push(r,o)}),c},ne=new te,F=new se,v=new Z,ie=({businesses:l=[],services:r=[],session:c,APP_DOMAIN:o,APP_PROTOCOL:m})=>{var B,R,C;const d=x.useRef(),y=x.useRef(),w=x.useRef(),[j,T]=x.useState(h.GET.business),[U,J]=x.useState({}),[i,g]=x.useState(null),[z,H]=x.useState([]),[W,N]=x.useState(null);x.useEffect(()=>{b()},[j]);const b=async()=>{const s=await F.byBusiness(j),a={};for(const n of s)a[n.service.correlative]=n;return J(a),a},S=({id:s,text:a,element:n})=>{if(!s)return;const t=JSON.parse($(n).attr("data")),p=document.createElement("div");return p.style.display="block",O(p).render(e.jsx(e.Fragment,{children:e.jsx("div",{className:"relative d-flex align-items-center py-2",children:e.jsxs("div",{className:"flex-grow-1 overflow-hidden",children:[e.jsxs("h5",{className:"mt-0 mb-1 text-truncate",children:[e.jsx("i",{className:"fa fa-building me-1"}),a]}),e.jsxs("p",{className:"d-block text-gray mb-0 font-13 text-truncate",children:[t.owner.name," ",t.owner.lastname]})]})})})),p},_=s=>{const a=$(d.current).find("option:selected"),t=JSON.parse(a.attr("data")).person.document_number;history.pushState(null,null,`/services?business=${t}`),T(t)},q=async(s,a)=>{const{isConfirmed:n}=await Y.fire({title:"¿Estás seguro?",text:"Habilitar el servicio puede aumentar los costos.",icon:"info",showCancelButton:!0,confirmButtonText:"Continuar",cancelButtonText:"Cancelar"});if(!n)return;N(a),s.target.disabled=!0;const t=await F.enableService(j,a);s.target.disabled=!1,N(null),t&&b()},A=async s=>{g(s),$(w.current).modal("show")},M=async()=>{var n,t;const s=[["email","contains",y.current.value]];(n=i==null?void 0:i.users)!=null&&n.length&&s.push("and",["!",ae((t=i==null?void 0:i.users)==null?void 0:t.map(({email:p})=>["email","=",p]),"or")]);const a=await ne.paginate({filter:s});console.log(a),H((a==null?void 0:a.data)??[])},D=async s=>{const a=i.id;if(!await v.inviteUser(s,a))return;const t=await b();g(t[i.service.correlative])},I=async s=>{if(!await v.delete(s))return;const n=await b();g(n[i.service.correlative])},K=async({correlative:s})=>{const a=$(d.current).find("option:selected"),n=JSON.parse(a.attr("data"));await v.authorize({service:s,business:n.uuid})&&(location.href=`${m}://${s}.${o}/home`)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"d-flex align-items-center justify-content-center",style:{minHeight:"calc(100vh - 135px)"},children:e.jsxs("div",{children:[e.jsx("div",{className:"mx-auto",style:{width:"240px"},children:e.jsx(L,{eRef:d,templateResult:S,templateSelection:S,onChange:_,children:l.map((s,a)=>e.jsx("option",{value:s.id,data:JSON.stringify(s),selected:h.GET.business==s.person.document_number,children:s.name},`business-${a}`))})}),e.jsx("hr",{className:"mx-auto",style:{width:"180px"}}),e.jsx("div",{className:"d-flex flex-wrap align-items-center justify-content-center gap-3",children:r.sort((s,a)=>a.status-s.status).map((s,a)=>{const n=U[s.correlative];return e.jsx("div",{className:"card mb-0",style:{width:"100%",maxWidth:"360px"},children:e.jsxs("div",{className:"card-body project-box",children:[e.jsx("div",{className:"badge bg-primary float-end",children:"Gratis"}),e.jsx("h4",{className:"mt-0",children:e.jsxs("a",{href:"#",className:"text-dark d-flex gap-1 align-items-center",onClick:()=>K(s),children:[e.jsx("img",{src:`//${s.correlative}.${o}/assets/img/icon.svg`,alt:s.name,style:{height:"20px",aspectRatio:1,objectFit:"contain",objectPosition:"center"},onError:t=>t.target.src="/assets/img/icon.svg"})," ",s.name," ",e.jsx("i",{className:"mdi mdi-arrow-top-right"})]})}),e.jsxs("p",{className:"text-success text-lowercase font-13",children:[s.correlative,".",o]}),e.jsx("p",{className:"text-muted font-13",style:{display:"-webkit-box",WebkitLineClamp:2,textOverflow:"ellipsis",WebkitBoxOrient:"vertical",overflow:"hidden",height:"38px"},children:s.description}),e.jsx("div",{className:"project-members mb-0",children:n?e.jsxs(e.Fragment,{children:[e.jsx("h5",{className:"float-start me-3",children:"Equipo :"}),e.jsxs("div",{className:"avatar-group",children:[n.users.map((t,p)=>{var E,k;return e.jsx("div",{className:"avatar-group-item mb-0",children:e.jsx(f,{content:`${((E=t==null?void 0:t.person)==null?void 0:E.name)||(t==null?void 0:t.name)} ${((k=t==null?void 0:t.person)==null?void 0:k.lastname)||(t==null?void 0:t.lastname)} ${c.id==t.id&&"(Tú)"}`,children:e.jsx("img",{src:`/api/profile/thumbnail/${t.relative_id}`,className:"rounded-circle avatar-sm",alt:`${t.name} ${t.lastname}`})})},`user-${p}`)}),e.jsx("div",{className:"avatar-group-item mb-0",style:{cursor:"pointer"},onClick:()=>A(n),children:e.jsx(f,{content:"Gestionar usuarios",children:e.jsx("img",{src:"/assets/img/plus.svg",className:"rounded-circle avatar-sm",alt:"Gestionar usuarios",style:{backgroundColor:"rgba(255, 255, 255, .5)",border:"1px solid transparent"}})})})]})]}):s.status?e.jsx(f,{content:"Habilitar servicio",children:e.jsx("button",{type:"button",className:"btn btn-sm btn-soft-primary rounded-pill waves-effect waves-light",onClick:t=>q(t,s.correlative),children:W?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-spin mdi-shape-circle-plus"})," Habilitando"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"mdi mdi-plus"})," Habilitar"]})})}):e.jsx("span",{style:{position:"relative",marginLeft:"-24px",display:"block",backgroundColor:"#f9c851",color:"#343a40",padding:".28rem 1.56rem",width:"max-content",borderRadius:"0 25px 25px 0"},children:"Proximamente"})})]})},`service-${a}`)})})]})}),e.jsxs(ee,{modalRef:w,onSubmit:s=>s.preventDefault(),title:`Gestionar acceso a ${(B=i==null?void 0:i.service)==null?void 0:B.name}`,size:"md",isStatic:!0,hideFooter:!0,children:[e.jsxs("div",{className:"d-block btn-group mx-auto",style:{width:"max-content"},children:[e.jsxs("button",{type:"button",className:"btn btn-secondary dropdown-toggle","data-bs-toggle":"dropdown","aria-expanded":"false",children:[e.jsx("i",{className:"fa fa-user-plus"})," Agregar usuarios a este servicio"]}),e.jsxs("div",{className:"dropdown-menu dropdown-menu-center p-2",style:{width:"100%"},children:[e.jsx("input",{ref:y,className:"form-control mb-2",type:"text",onChange:M}),z.map((s,a)=>{var n,t;return e.jsx(e.Fragment,{children:e.jsxs("a",{className:"dropdown-item py-1 px-2 border-t",href:"#",onClick:()=>D(s.email),children:[e.jsxs("p",{className:"mb-0 text-bold text-truncate",children:[((n=s==null?void 0:s.person)==null?void 0:n.name)||(s==null?void 0:s.name)," ",((t=s==null?void 0:s.person)==null?void 0:t.lastname)||(s==null?void 0:s.lastname)]}),e.jsx("p",{className:"mb-0 text-muted text-truncate",style:{fontSize:"small"},children:s.email})]},`user-${a}`)})})]})]}),e.jsx("hr",{className:"mx-auto",style:{maxWidth:"240px",width:"100%"}}),e.jsx("div",{children:((R=i==null?void 0:i.users)==null?void 0:R.length)>0?e.jsx("table",{style:{width:"100%"},children:e.jsx("tbody",{children:(C=i==null?void 0:i.users)==null?void 0:C.map((s,a)=>{var n,t;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("img",{src:`/api/profile/thumbnail/${s.relative_id}`,className:"rounded-circle avatar-sm me-1",alt:`${s.name} ${s.lastname}`})}),e.jsx("td",{children:e.jsxs("div",{children:[e.jsxs("h5",{className:"mt-1 mb-1 text-truncate",children:[((n=s==null?void 0:s.person)==null?void 0:n.name)||(s==null?void 0:s.name)," ",((t=s==null?void 0:s.person)==null?void 0:t.lastname)||(s==null?void 0:s.lastname)]}),e.jsx("p",{className:"mb-1 text-truncate",style:{fontSize:"small"},children:s==null?void 0:s.email})]})}),e.jsxs("td",{align:"center",children:[s.pivot.invitation_accepted==!1&&e.jsx(f,{content:"El usuario no ha aceptado la invitacion",children:e.jsx("p",{className:"mb-0 text-danger",style:{fontSize:"small"},children:"Pendiente"})}),e.jsx("button",{className:"btn btn-xs btn-white rounded-pill",onClick:()=>I(s.pivot.id),children:e.jsx("i",{className:"fa fa-trash"})})]})]},`user-${a}`)})})}):e.jsx("i",{className:"d-block text-center text-muted",children:"- No hay usuarios vinculados -"})})]})]})};V((l,r)=>{O(l).render(e.jsx(X,{...r,title:"Servicios",children:e.jsx(ie,{...r})}))});
